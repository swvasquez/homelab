#
# Installs and configures a comprehensive Python development environment.
#
# This playbook performs the following actions:
#   - Installs Python 3 and essential development packages from APT.
#   - Downloads and installs Miniconda system-wide to /opt/miniconda3.
#   - Adds Miniconda's bin directory to the system-wide PATH.
#   - Installs 'uv', a fast Python package installer and resolver from Astral,
#     into /usr/local/bin.
#
# The 'uv' version can be specified by setting the 'uv_version' variable.
#

- name: Set up Python environment
  hosts: all
  become: true
  become_exe: sudo.ws
  vars:
    python3_packages:
      - python3
      - python3-pip
      - python3-venv
      - python3-dev
      - python3-setuptools
      - python3-wheel
      - build-essential
      - libssl-dev
      - libffi-dev
      - libbz2-dev
      - libreadline-dev
      - zlib1g-dev
      - libsqlite3-dev
    miniconda_prefix: /opt/miniconda3
    miniconda_installer: Miniconda3-latest-Linux-x86_64.sh
    miniconda_download_url: https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
    uv_version: "0.1.18"
  tasks:
    - name: Install Python 3 and development packages
      ansible.builtin.apt:
        name: "{{ python3_packages }}"
        state: present
        update_cache: true

    - name: Check if Miniconda is installed
      ansible.builtin.stat:
        path: "{{ miniconda_prefix }}/bin/conda"
      register: miniconda_stat

    - name: Download and install Miniconda
      when: not miniconda_stat.stat.exists
      block:
        - name: Download Miniconda installer
          ansible.builtin.get_url:
            url: "{{ miniconda_download_url }}"
            dest: "/tmp/{{ miniconda_installer }}"
            mode: "0755"
          become: false

        - name: Install Miniconda
          ansible.builtin.command:
            cmd: "bash /tmp/{{ miniconda_installer }} -b -p {{ miniconda_prefix }}"
          args:
            creates: "{{ miniconda_prefix }}/bin/conda"

        - name: Clean up Miniconda installer
          ansible.builtin.file:
            path: "/tmp/{{ miniconda_installer }}"
            state: absent
          become: false

    - name: Add Miniconda to system-wide PATH
      ansible.builtin.copy:
        dest: /etc/profile.d/miniconda.sh
        content: 'export PATH="{{ miniconda_prefix }}/bin:$PATH"'
        mode: "0644"

    - name: Check installed 'uv' version
      become: false
      ansible.builtin.command:
        cmd: uv --version
      register: uv_installed
      changed_when: false
      failed_when: false
      ignore_errors: true

    - name: Install or update 'uv' package manager
      ansible.builtin.shell:
        cmd: 'UV_INSTALL_DIR=/usr/local/bin UV_VERSION={{ uv_version }} sh -c "$(curl -LsSf https://astral.sh/uv/install.sh)"'
        executable: /bin/bash
      when: uv_installed.rc != 0 or uv_version not in uv_installed.stdout
      register: uv_install_result
      changed_when: "'successfully installed' in uv_install_result.stderr"
